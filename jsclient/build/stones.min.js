/*
 * Stones
 * Copyright (c) 2013 Carlos León
 * 
 * Licensed under the MIT license (http://mit-license.org/)
 */

window.stones = {};

(function ($, angular, window) {
  // Stones module definition and configuration
  'use strict';
  window.stones = angular.module('stones', []);
  window.stones.config([
    '$locationProvider',
    function ($locationProvider) {
      $locationProvider.hashPrefix('!');
    }]);
  window.stones.run([
    '$rootScope',
    'stones.translator_opts',
    function ($rootScope, translator_opts) {
      $rootScope.$_ = translator_opts.translate;
    }]);
}(window.jQuery, window.angular, window));

(function ($, angular, stones) {
  // Stones services
  'use strict';

  /*
   * Handles unsuccessful responses from server.
   */
  stones.factory('stones.server_error_handler', [
    '$exceptionHandler',
    function ($exceptionHandler) {
      return function (data) {
        console.log(data.status);
      };
    }]);

  /*
   * Returns a function to retrieve a list of entities.
   */
  stones.factory('stones.get_entities', [
    '$http',
    'stones.server_error_handler',
    function ($http, server_error_handler) {
      return function (url, cache) {
        return function (params) {
          var http_opts = {
            url: url,
            method: 'GET',
            params: params
          };

          if (cache) {
            http_opts.cache = cache;
          }

          return $http(http_opts).then(function (data) {
            return data.data;
          }, function (data) {
            server_error_handler(data);
            return [];
          });
        };
      };
    }]);

  /*
   * Returns a function to retrieve one entity by key or id.
   */
  stones.factory('stones.get_entity', [
    '$http',
    'stones.server_error_handler',
    function ($http, server_error_handler) {
      return function (url) {
        return function (key) {
          var http_opts = {
            url: url + key,
            method: 'GET'
          };

          return $http(http_opts).then(function (data) {
            return data.data;
          }, function (data) {
            server_error_handler(data);
            return {};
          });
        };
      };
    }]);

  /*
   * Returns a function to delete/erase one entity by key or id.
   */
  stones.factory('stones.delete_entity', [
    '$http',
    'stones.server_error_handler',
    function ($http, server_error_handler) {
      return function (url) {
        return function (entity) {
          var http_opts = {
            url: url + entity.$$key$$,
            method: 'DELETE'
          };

          return $http(http_opts).then(function (data) {
            return true;
          }, function (data) {
            server_error_handler(data);
            return false;
          });
        };
      };
    }]);

  /*
   * Returns a function to save/modify one entity by key or id.
   */
  stones.factory('stones.save_entity', [
    '$http',
    'stones.server_error_handler',
    function ($http, server_error_handler) {
      return function (url) {
        return function (entity) {
          var own_entity = angular.copy(entity),
            http_opts = {
              url: url,
              method: 'POST',
              data: own_entity
            };

          if (own_entity.$$key$$ || own_entity.$$id$$) {
            http_opts.method = 'PUT';
            http_opts.url += (own_entity.$$key$$ || own_enity.$$id$$);
          }

          return $http(http_opts).then(function (data) {
            return data.data;
          }, function (data) {
            server_error_handler(data);
            return null;
          });
        };
      };
    }]);

  /*
   * Return a valid date formatted to work with Stones Server.
   * Uses sugar.js to perform date format.
   */
  stones.factory('stones.get_valid_date_string', [
    function () {
      return function (date) {
        return date.format('{yyyy}-{MM}-{dd}T{HH}:{mm}:{ss}Z');
      };
    }]);

}(window.jQuery, window.angular, window.stones));

(function ($, angular, stones) {
  // Stones directives
  'use strict';
  stones.directive('stNumber', [
    function () {
      return {
        require: '^?ngModel',
        link: function (scope, elm, attrs, ctrl) {
          if (!ctrl) { return; }
          function validator (value) {
            if (!angular.isNumber(value)) {
              var transformed = Number(value);
              if (transformed === 0 || Boolean(transformed)) {
                return transformed;
              } else {
                ctrl.$setValidity('stNumberError', false);
                ctrl.$setViewValue(null);
              }
            }
            return value;
          }

          ctrl.$parsers.push(validator);
          ctrl.$formatters.push(validator);
        }
      };
    }]);
  stones.directive('stTypeahead', [
    '$parse',
    '$compile',
    function ($parse, $compile) {
      var tpl = '<ul class="typeahead dropdown-menu st-typeahead"><li ng-repeat="$item in $matched_items" ng-click="$select_item($item)" ng-class="$set_item_class($item)"><a href="">{{$item.label}}</a></li></ul>',
        typeahead_controller;
      typeahead_controller = [
        '$scope',
        '$attrs',
        function ($scope, $attrs) {
          var label_attr = $attrs.stLabel,
            value_attr = $attrs.stValue,
            deny_new = Boolean($attrs.stDenyNew),
            select_fn = $parse($attrs.stSelect),
            sort_fn = $parse($attrs.stSort),
            ctrl = this;

          ctrl.model_ctrl = null;
          ctrl.elm = null;
          ctrl.menu = null;
          ctrl.current_item = null;
          ctrl.focused = false;
          ctrl.mousedover = false;
          ctrl.index = null;
          ctrl.source = [];
          ctrl.show_counter = 0;

          $scope.$matched_items = [];
          $scope.$watch('current_item', function (value, old) {
            if (value && value !== old) {
              ctrl.model_ctrl.$setViewValue(value.label);
            }
          });

          ctrl.set_index = function (index) {
            ctrl.index = index;
          };

          ctrl.set_menu = function (menu) {
            ctrl.menu = angular.element(menu);
            ctrl.menu.bind('mouseenter', ctrl.mouseenter);
            ctrl.menu.bind('mouseleave', ctrl.mouseleave);
          };

          ctrl.set_element = function (elm) {
            ctrl.elm = angular.element(elm);
          };

          ctrl.set_model_ctrl = function (model_ctrl) {
            ctrl.model_ctrl = model_ctrl;
          }

          ctrl.set_source = function (value) {
            var items = [];
            function get_label(item) {
              if (label_attr) {
                return item[label_attr];
              } else {
                return item;
              }
            }

            function get_value(item) {
              if (value_attr) {
                return item[value_attr];
              } else {
                return item;
              }
            }

            if (angular.isArray(value)) {
              value.each(function (n) {
                items.push({
                  label: get_label(n),
                  value: get_value(n)
                });
              });
            } else if (angular.isObject(value)) {
              for (var key in value) {
                items.push({
                  label: key,
                  value: get_value(value[key])
                });                
              }
            }
            ctrl.source = items;
          };

          ctrl.match_items = function (value, digest) {
            if (ctrl.show_counter === 0) { return; }
            var sort = sort_fn($scope);
            if (!value || value === '') {
              $scope.$matched_items = ctrl.source;
            } else {
              $scope.$matched_items = ctrl.source.filter(function (n) {
                return n.label.toLowerCase().has(value.toLowerCase());
              });
              $scope.$matched_items = $scope.$matched_items || [];
              if ($scope.$matched_items.length > 0) {
                $scope.$matched_items.each(function (n) {
                  if (n.label === value) ctrl.selected = true;
                });
              }
            }
            if (sort) {
              $scope.$matched_items = $scope.$matched_items.sortBy(sort);
            } else if (sort === false) {
              // no sort
            } else {
              $scope.$matched_items = $scope.$matched_items.sortBy('label');
            }
            ctrl.current_item = $scope.$matched_items[0];
            if (digest) {
              try { $scope.$apply(); } catch (e) {}
            }
            ctrl.show();
          };

          ctrl.select_item = function (item) {
            var fn = select_fn($scope);
            function select(local_item) {
              ctrl.model_ctrl.$setViewValue(local_item.label);
              ctrl.elm.val(local_item.label);
              if (fn && angular.isFunction(fn)) {
                fn(local_item.value, ctrl.index);
              }              
            }
            if (item) {
              select(item);
            } else {
              item = ctrl.current_item;
              if (item) {
                select(item);
              } else {
                if (deny_new) {
                  ctrl.model_ctrl.$setViewValue('');
                  ctrl.elm.val('');
                  if (fn && angular.isFunction(fn)) {
                    fn();
                  }
                }
              }
            }
            ctrl.hide();
            ctrl.show_counter = 0;
          };

          ctrl.keydown = function (e) {
            switch (e.keyCode) {
              case 9:
                ctrl.select_item();
                break;
              case 13:
                e.preventDefault();
                ctrl.select_item();
                break;
              case 38:
                ctrl.next();
                break;
              case 40:
                ctrl.prev();
                break;
              case 27:
                ctrl.hide();
                break;
              default:
                ctrl.show_counter++;
            }
          };

          ctrl.prev = function () {
            var index = $scope.$matched_items.indexOf(ctrl.current_item);
            if (index === $scope.$matched_items.length - 1) {
              index -= 1;
            }
            ctrl.current_item = $scope.$matched_items[index + 1];
            try { $scope.$apply(); } catch (e) {}
          };

          ctrl.next = function () {
            var index = $scope.$matched_items.indexOf(ctrl.current_item);
            if (index === 0) {
              index += 1;
            }
            ctrl.current_item = $scope.$matched_items[index - 1];
            try { $scope.$apply(); } catch (e) {}
          };

          ctrl.focus = function (e) {
            var empty = e.currentTarget.value === '';
            if (empty) { ctrl.show_counter++; }
            ctrl.focused = true;
            ctrl.match_items(e.currentTarget.value, true);
          };

          ctrl.blur = function (e) {
            ctrl.focused = false;
            if (!ctrl.mousedover) { ctrl.hide(); }
          };

          ctrl.show = function () {
            if ($scope.$matched_items.length > 0) {
              var offset = ctrl.elm.offset();
              offset.top += ctrl.elm[0].offsetHeight + 2;
              ctrl.menu.css('top', offset.top);
              ctrl.menu.css('left', offset.left);
              ctrl.menu.show();
            } else {
              ctrl.hide();
            }
          };

          ctrl.hide = function () {
            ctrl.menu.hide();
          };

          ctrl.mouseenter = function (e) {
            ctrl.mousedover = true;
            ctrl.menu.find('li').removeClass('active');
          };

          ctrl.mouseleave = function (e) {
            ctrl.mousedover = false;
            var index = $scope.$matched_items.indexOf(ctrl.current_item);
            if (index !== -1) {
              ctrl.menu.find('li').eq(index).addClass('active');
            }
          };
        }];

      function linker(scope, elm, attrs, ctrl) {
        var typeahead_ctrl = ctrl[0],
          model_ctrl = ctrl[1],
          menu = null;
        if (!typeahead_ctrl || !model_ctrl) { return; }
        typeahead_ctrl.set_model_ctrl(model_ctrl);
        typeahead_ctrl.set_element(elm);
        if (scope.$index !== undefined) {
          typeahead_ctrl.set_index(scope.$index);
        }
        scope.$watch(attrs.stTypeahead, function (value) {
          typeahead_ctrl.set_source(value);
        });
        scope.$watch(attrs.ngModel, function (value, old) {
          if (value === old) { return; }
          typeahead_ctrl.match_items(value, false);
        });
        menu = $compile(tpl)(scope);
        typeahead_ctrl.set_menu(menu);
        angular.element('body').append(menu);
        scope.$on('$destroy', function (e) {
          menu.remove();
        });
        elm.bind('keydown', typeahead_ctrl.keydown);
        elm.bind('focus', typeahead_ctrl.focus);
        elm.bind('blur', typeahead_ctrl.blur);
        scope.$select_item = typeahead_ctrl.select_item;
        scope.$set_item_class = function (item) {
          var rv = '';
          if (item === typeahead_ctrl.current_item) {
            rv += 'active ';
          }
          return rv.trim();
        };
      }

      return {
        restrict: 'A',
        require: ['stTypeahead', '^?ngModel'],
        scope: true,
        controller: typeahead_controller,
        link: linker,
      };
    }]);
  stones.directive('stMenu', [
    '$location',
    function ($location) {
      return {
        restrict: 'EA',
        link: function (scope, elm) {
          var patterns = [];
          elm.find('a').map(function (_, a) {
            patterns.push(a.hash.remove(/[#!\/]/g));
          });
          scope.$on('$routeChangeSuccess', function () {
            var current_path = Array.create($location.path().split('/').remove('')),
              match = patterns.find(function (n) {
                return current_path.some(n);
              });
            elm.find('a').map(function (_, a) {
              var ul, li;
              if (a.hash.has(match)) {
                li = angular.element(a).parent();
                ul = li.parent();
                ul.find('li').removeClass('active');
                li.addClass('active');
              }
            });
          });
        }
      };
    }]);
  stones.directive('input', [
    function () {      
      return {
        restrict: 'E',
        require: '?ngModel',
        link: function (scope, elm, attrs, ctrl) {
          if (!ctrl || attrs.type !== 'range') { return; }
          function listener() {
            var value = elm.val().toNumber();
            if (ctrl.$viewValue !== value) {
              scope.$apply(function () {
                ctrl.$setViewValue(value);
              });
            }
          }
          elm.bind('change', listener);
        }
      }
    }]);
  stones.directive('input', [
    // type file support to input
    function () {
      return {
        restrict: 'E',
        require: '?ngModel',
        link: function (scope, elm, attrs, ctrl) {
          if (!ctrl || attrs.type !== 'file') { return; }
          var mimetype = attrs.mimetype,
            listener = function () {
              var file = elm[0].files[0],
                reader = new FileReader();
              reader.onload = function (f) {
                var result = f.target.result;
                scope.$apply(function () {
                  ctrl.$setViewValue(result);
                });
              };
              if (mimetype === undefined || file.type.has(mimetype)) {
                reader.readAsDataURL(file);
              } else {
                scope.$apply(function () {
                  ctrl.$setViewValue('');
                });
                elm.val('');
              }
            };
          elm.bind('change', listener);
          ctrl.$render = function () {};
        }
      };
    }]);
  stones.directive('stFilter', [
    '$compile',
    '$parse',
    function ($compile, $parse) {
      return {
        link: function (scope, elm, attrs) {
          var control_tpl = scope.$filter.control_tpl,
            control;
          if (control_tpl === 'textinput' || control_tpl === undefined) {
            control_tpl = '<input style="margin-bottom:0;" type="text" ng-class="$filter.css_class" ng-model="$search_obj.{1}">'.assign(scope.$filter.search_obj_attr);
          }
          if (control_tpl) {
            control = $compile(control_tpl)(scope);
            elm.replaceWith(control);
          }
        }
      }
    }]);
  stones.directive('stEntitiesTable', [
    '$compile',
    '$parse',
    '$location',
    '$http',
    '$routeParams',
    '$timeout',
    '$filter',
    'stones.server_error_handler',
    function ($compile, $parse, $location, $http, $routeParams, $timeout,
        $filter, server_error_handler) {
      var tpl = '<div class="entities-container-filters" ng-class="$filters_container_classes" ng-show="$filtered"><h1>{{$_("Filters")}}</h1><div class="entities-container-filter" style="margin-bottom:10px;" ng-class="$filter_container_classes" ng-repeat="$filter in $filters"><label><i class="icon-minus-sign pull-right" ng-show="$filter.remove" ng-click="$remove_filter($filter)"></i>{{$filter.label}}</label><div st-filter></div></div></div><div class="entities-container-title" ng-class="$title_container_classes"><h1>{{$title}} <i ng-show="$actions.add" style="cursor:pointer;" title="{{$_(\'Add entity\')}}" class="icon-plus-sign pull-right" ng-click="$update_route_params(\'new\')"></i> <span class="pull-right clearfix title_addon_container" ng-bind-html-unsafe="$title_addon($entities)"></span></h1></div><div class="entities-table-container" ng-class="$table_container_classes"><table class="table table-bordered table-striped table-hover" ng-class="$table_classes"><thead><th></th><th ng-repeat="h in $table_headers">{{$_(h.label)}}</th><th></th></thead><tbody><tr ng-repeat="$entity in $entities_filtered"><td style="text-align:center;" ng-bind-html-unsafe="$entity_info($entity)"></td><td ng-repeat="h in $table_headers" ng-bind-html-unsafe="$get_value($entity, h.attr)"></td><td style="text-align:center;"><span ng-bind-html-unsafe="$entity_addon($entity)"></span> <i ng-show="$actions.edit" style="cursor:pointer;" title="{{$_(\'Edit entity\')}}" class="icon-pencil" ng-click="$update_route_params($entity.$$key$$)"></i> <i ng-show="$actions.erase" style="cursor:pointer;" title="{{$_(\'Erase entity\')}}" class="icon-trash" ng-click="$show_erase_confirmation($entity)"></i></td></tr><tr ng-show="!$entities_loaded"><td colspan="{{$table_headers.length + 2}}"><i class="icon-spin icon-spinner"></i> {{$_("Loading...")}}</td></tr><tr ng-show="$entities_loaded && $entities_filtered.length == 0"><td colspan="{{$table_headers.length + 2}}">{{$_("Nothing to show.")}}</td></tr></tbody></table></div>',
        modal_tpl = '<div class="modal hide fade" id="delete-modal"><div class="modal-header"><h3>{{$_("Erase one entity")}}</h3></div><div class="modal-body"><p>{{$_("You are going to erase this entity. Are you sure?")}}</p></div><div class="modal-footer"><button class="btn btn-danger" ng-click="$erase()">{{$_("Yes, i\'m sure.")}}</button><button class="btn btn-success" ng-click="$hide_erase_confirmation()">{{$_("No. Get me out of here.")}}</button></div></div>',
        st_entities_table_ctrl;
      st_entities_table_ctrl = ['$scope', '$element', '$attrs',
        function (scope, elm, attrs) {
          scope.$entities = [];
          scope.$entities_filtered = [];
          scope.$filters = scope.filters;
          scope.$search_obj = {};
          scope.$filtered = scope.filters && (scope.filters.length > 0);
          scope.$watch(function () {
            scope.$entities_filtered = $filter('stFilter')(scope.$entities,
              scope.$filters, scope.$search_obj);
          });
          scope.$remove_filter = function (filter) {
            delete scope.$search_obj[filter.search_obj_attr];
          };
          scope.$entity_addon = scope.entity_addon;
          scope.$entity_info = scope.entity_info;
          scope.$title_addon = scope.title_addon;
          scope.$table_container_classes = attrs.tableContainerClasses;
          scope.$table_classes = attrs.tableClasses;
          scope.$title_container_classes = attrs.titleContainerClasses;
          scope.$filters_container_classes = attrs.filtersContainerClasses;
          scope.$filter_container_classes = attrs.filterContainerClasses;
          scope.$table_headers = scope.table_headers || [];
          scope.$remote_url = scope.remote_url;
          if (scope.$remote_url === undefined) {
            throw 'EntitiesTableError: No remote url defined.';
          }
          scope.$local_url = scope.local_url || '';
          scope.$title = attrs.title && attrs.title.capitalize();
          scope.$actions = {
            add: attrs.actions && attrs.actions.toLowerCase().has('c'),
            edit: attrs.actions && attrs.actions.toLowerCase().has('u'),
            erase: attrs.actions && attrs.actions.toLowerCase().has('d')
          };          
          scope.$entities_loaded = false;
          scope.$update_route_params = function (sufix) {
            var current = $location.path();
            $location.path(current + sufix + '/');
          };
          scope.$get_value = function ($entity, attr) {
            var rv,
              label_tpl = '<span class="label label-info">{1}</span>';
            if (angular.isFunction(attr)) {
              rv = attr($entity);
            } else {
              rv = $parse(attr)($entity);
            }
            if (Object.isArray(rv)) {
              rv = rv.map(function (n) {
                return label_tpl.assign(n);
              }).join(' ');
            }
            return rv;
          };
          scope.$show_erase_confirmation = function (entity) {
            scope.$active_entity = entity;
            $('#delete-modal').modal('show');
          };
          scope.$hide_erase_confirmation = function () {
            scope.$active_entity = null;
            $('#delete-modal').modal('hide');
          };
          scope.$erase = function () {
            $http({
              url: scope.$remote_url + scope.$active_entity.$$key$$,
              method: 'DELETE'
            }).then(function (data) {
              scope.$entities.remove(scope.$active_entity);
              scope.$active_entity = null;
              $('#delete-modal').modal('hide');
            }, function (data) {
              server_error_handler(data);
            })
          };
          // get entities
          scope.$aditional_params = scope.aditional_params;
          scope.$cache = scope.cache;
          scope.$load_entities = function () {
            var http_opts = {
              url: scope.$remote_url,
              method: 'GET',
              params: $routeParams
            };
            if (scope.$cache) {
              var cache_name = http_opts.url;
              if (Object.size($routeParams) > 0) {
                cache_name += '?' + $.param($routeParams);
              }
              scope.$cache.put(cache_name, '');
              scope.$cache.remove(cache_name);
              http_opts.cache = scope.$cache;
            }
            if (scope.$aditional_params) {
              angular.extend(http_opts.params, scope.$aditional_params);
            }
            $http(http_opts).then(function (data) {
              scope.$entities = data.data;
              scope.$entities_loaded = true;
            }, function (data) {
              server_error_handler(data);
              scope.$entities_loaded = true;
            });
          };
        }];

      return {
        restrict: 'EA',
        scope: true,
        controller: st_entities_table_ctrl,
        link: function (scope, elm, attrs, ctrl) {
          elm.removeAttr('title');
          elm.replaceWith($compile(tpl)(scope));

          var modal = $compile(modal_tpl)(scope);
          angular.element('body').append(modal);
          scope.$on('$destroy', function () {
            modal.remove();
          });
          $('#delete-modal').modal({show: false});

          $timeout(scope.$load_entities, 2000);
        }
      };
    }]);
  stones.directive('required', [
    'stones.translator',
    '$compile',
    function (_, $compile) {
      return {
        require: '?ngModel',
        restrict: 'A',
        link: function (scope, elm, attrs, ctrl) {
          if (!ctrl) { return; }
          var error_tpl = '<div class="error">{1}</div>',
            error_elm = $compile(
              error_tpl.assign(_('This field is mandatory.'))
            )(scope);
          $(elm).after(error_elm);
          scope.$watch(attrs.ngModel, function (value) {
            if (!value && ctrl.$dirty) {
              error_elm.css('display', 'block');
            } else {
              error_elm.css('display', 'none');
            }
          });
        }
      };
    }]);

  stones.directive('stPlaceholder', [
    '$compile',
    function ($compile) {
      return {
        require: '?ngModel',
        restrict: 'A',
        priority: 99,
        link: function (scope, elm, attrs, ctrl) {
          if (!ctrl) { return; }
          scope.$placeholder = '';
          var placeholder_tpl = '<span class="control-placeholder">{{$placeholder}}</span>',
            placeholder_elm = $compile(placeholder_tpl)(scope);
          $(elm).before(placeholder_elm).removeAttr('placeholder');
          placeholder_elm.css('position', 'absolute');
          placeholder_elm.bind('click', function (e) {
            $(elm).focus();
          });
          attrs.$observe('stPlaceholder', function (value) {
            scope.$placeholder = value;            
          });
          scope.$watch(attrs.ngModel, function (value) {
            if (value === undefined || value === null || value === '') {
              placeholder_elm.css('display', 'inline-block');
            } else {
              placeholder_elm.css('display', 'none');
            }
          });
        }
      };
    }]);

  stones.directive('stDatePicker', [
    function () {
      return {
        require: '?ngModel',
        link: function (scope, elm, attrs, ctrl) {
          if (!ctrl) { return; }
          $(elm).datepicker();
        }
      }
    }]);
}(window.jQuery, window.angular, window.stones));

(function ($, angular, stones) {
  // locales definition
  'use strict';
  stones.constant('stones.locales', {
    es: {
      'This field is mandatory.': 'Este campo es obligatorio.',
      'Nothing to show.': 'Nada que mostrar.',
      'Loading...': 'Cargando...',
      'Add entity': 'Agregar entidad',
      'Edit entity': 'Editar entidad',
      'Erase one entity': 'Borrar una entidad',
      'You are going to erase this entity. Are you sure?': 'Estás a punto de borra esta entidad. ¿Estás seguro/a?',
      'Yes, i\'m sure.': 'Sí, lo estoy.',
      'No. Get me out of here.': 'No. Sácame de aquí.',
      'Filters': 'Filtros'
    }
  });
}(window.jQuery, window.angular, window.stones));

(function ($, angular, stones) {
  // locale support
  'use strict';
  stones.factory('stones.translator_opts', [
    '$window',
    'stones.locales',
    function ($window, default_locales) {
      var lang = $window.navigator.language ||
          $window.navigator.userLanguage || $window.navigator.systemLanguage,
        locales = default_locales;
      lang = lang.to(2);
      $('body').append(
        '<script src="/static/j/locales/{1}.js"><\/script>'.assign(lang)
      );
      if ($window.Date.getLocale(lang)) {
        $window.Date.setLocale(lang);
      }
      return {
        set_locale: function (lang_) {
          lang = lang_;
        },
        get_locale: function () {
          return lang;
        },
        add_locale_table: function (lang_, hash) {
          locales[lang_] = hash;
        },
        translate: function (str) {
          var locale = locales[lang],
            rv;
          if (locale === undefined) { return str; }
          rv = locale[str];
          if (rv === undefined) { return str; }
          return rv;
        }
      };
    }]);
  stones.factory('stones.translator', [
    'stones.translator_opts',
    function (translator) {
      return translator.translate;
    }]);
}(window.jQuery, window.angular, window.stones));

(function ($, angular, stones) {
  // Filters
  'use strict';
  stones.filter('stFilter', [
    function () {
      return function (input, filters, search_obj) {
        filters = filters || [];
        if (!angular.isArray(filters)) {
          throw 'StonesFilterError: filters should be an array.';
        }
        filters.each(function (filter) {
          var value = search_obj[filter.search_obj_attr],
            entity_value;
          if (value !== undefined) {
            input = input.filter(function (entity) {
              if (angular.isFunction(filter.filter)) {
                return filter.filter(entity, value);
              } else if (angular.isString(filter.filter)) {
                entity_value = filter.filter.namespace(entity) || '';
                if (entity_value.toLowerCase === undefined) {
                  throw 'StonesFilterError: You cannot perform default filter behavior over entity attributes but strings. Found {1}. You need to define a custom behavior in the filter definition.'.assign(typeof entity_value);
                }
                if (value.toLowerCase === undefined) {
                  throw 'StonesFilterError: You cannot perform default filter behavior over search arguments but strings. Found {1}. You need to define a custom behavior in the filter definition.'.assign(typeof entity_value);
                }
                return entity_value.toLowerCase().has(value.toLowerCase());
              }
            });            
          }
        });
        return input;
      }
    }]);
}(window.jQuery, window.angular, window.stones));

/* =========================================================
 * bootstrap-datepicker.js 
 * http://www.eyecon.ro/bootstrap-datepicker
 * =========================================================
 * Copyright 2012 Stefan Petre
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================= */
!function(d){var k=function(a,b){this.element=d(a);this.format=c.parseFormat(b.format||this.element.data("date-format")||"mm/dd/yyyy");this.picker=d(c.template).appendTo("body").on({click:d.proxy(this.click,this)});this.isInput=this.element.is("input");this.component=this.element.is(".date")?this.element.find(".add-on"):!1;if(this.isInput)this.element.on({focus:d.proxy(this.show,this),keyup:d.proxy(this.update,this)});else if(this.component)this.component.on("click",d.proxy(this.show,this));else this.element.on("click",
d.proxy(this.show,this));this.minViewMode=b.minViewMode||this.element.data("date-minviewmode")||0;if("string"===typeof this.minViewMode)switch(this.minViewMode){case "months":this.minViewMode=1;break;case "years":this.minViewMode=2;break;default:this.minViewMode=0}this.viewMode=b.viewMode||this.element.data("date-viewmode")||0;if("string"===typeof this.viewMode)switch(this.viewMode){case "months":this.viewMode=1;break;case "years":this.viewMode=2;break;default:this.viewMode=0}this.startViewMode=this.viewMode;
this.weekStart=b.weekStart||this.element.data("date-weekstart")||0;this.weekEnd=0===this.weekStart?6:this.weekStart-1;this.onRender=b.onRender;this.fillDow();this.fillMonths();this.update();this.showMode()};k.prototype={constructor:k,show:function(a){this.picker.show();this.height=this.component?this.component.outerHeight():this.element.outerHeight();this.place();d(window).on("resize",d.proxy(this.place,this));a&&(a.stopPropagation(),a.preventDefault());var b=this;d(document).on("mousedown",function(a){0==
d(a.target).closest(".datepicker").length&&b.hide()});this.element.trigger({type:"show",date:this.date})},hide:function(){this.picker.hide();d(window).off("resize",this.place);this.viewMode=this.startViewMode;this.showMode();this.isInput||d(document).off("mousedown",this.hide);this.element.trigger({type:"hide",date:this.date})},set:function(){var a=c.formatDate(this.date,this.format);this.isInput?this.element.prop("value",a):(this.component&&this.element.find("input").prop("value",a),this.element.data("date",
a))},setValue:function(a){this.date="string"===typeof a?c.parseDate(a,this.format):new Date(a);this.set();this.viewDate=new Date(this.date.getFullYear(),this.date.getMonth(),1,0,0,0,0);this.fill()},place:function(){var a=this.component?this.component.offset():this.element.offset();this.picker.css({top:a.top+this.height,left:a.left})},update:function(a){this.date=c.parseDate("string"===typeof a?a:this.isInput?this.element.prop("value"):this.element.data("date"),this.format);this.viewDate=new Date(this.date.getFullYear(),
this.date.getMonth(),1,0,0,0,0);this.fill()},fillDow:function(){for(var a=this.weekStart,b="<tr>";a<this.weekStart+7;)b+='<th class="dow">'+c.dates.daysMin[a++%7]+"</th>";b+="</tr>";this.picker.find(".datepicker-days thead").append(b)},fillMonths:function(){for(var a="",b=0;12>b;)a+='<span class="month">'+c.dates.monthsShort[b++]+"</span>";this.picker.find(".datepicker-months td").append(a)},fill:function(){var a=new Date(this.viewDate),b=a.getFullYear(),f=a.getMonth(),m=this.date.valueOf();this.picker.find(".datepicker-days th:eq(1)").text(c.dates.months[f]+
" "+b);var e=new Date(b,f-1,28,0,0,0,0),a=c.getDaysInMonth(e.getFullYear(),e.getMonth());e.setDate(a);e.setDate(a-(e.getDay()-this.weekStart+7)%7);var d=new Date(e);d.setDate(d.getDate()+42);for(var d=d.valueOf(),a=[],g,h,l;e.valueOf()<d;){e.getDay()===this.weekStart&&a.push("<tr>");g=this.onRender(e);h=e.getFullYear();l=e.getMonth();if(l<f&&h===b||h<b)g+=" old";else if(l>f&&h===b||h>b)g+=" new";e.valueOf()===m&&(g+=" active");a.push('<td class="day '+g+'">'+e.getDate()+"</td>");e.getDay()===this.weekEnd&&
a.push("</tr>");e.setDate(e.getDate()+1)}this.picker.find(".datepicker-days tbody").empty().append(a.join(""));f=this.date.getFullYear();a=this.picker.find(".datepicker-months").find("th:eq(1)").text(b).end().find("span").removeClass("active");f===b&&a.eq(this.date.getMonth()).addClass("active");a="";b=10*parseInt(b/10,10);m=this.picker.find(".datepicker-years").find("th:eq(1)").text(b+"-"+(b+9)).end().find("td");b-=1;for(e=-1;11>e;e++)a+='<span class="year'+(-1===e||10===e?" old":"")+(f===b?" active":
"")+'">'+b+"</span>",b+=1;m.html(a)},click:function(a){a.stopPropagation();a.preventDefault();var b=d(a.target).closest("span, td, th");if(1===b.length)switch(b[0].nodeName.toLowerCase()){case "th":switch(b[0].className){case "switch":this.showMode(1);break;case "prev":case "next":this.viewDate["set"+c.modes[this.viewMode].navFnc].call(this.viewDate,this.viewDate["get"+c.modes[this.viewMode].navFnc].call(this.viewDate)+c.modes[this.viewMode].navStep*("prev"===b[0].className?-1:1)),this.fill(),this.set()}break;
case "span":b.is(".month")?(a=b.parent().find("span").index(b),this.viewDate.setMonth(a)):(b=parseInt(b.text(),10)||0,this.viewDate.setFullYear(b));0!==this.viewMode&&(this.date=new Date(this.viewDate),this.element.trigger({type:"changeDate",date:this.date,viewMode:c.modes[this.viewMode].clsName}));this.showMode(-1);this.fill();this.set();break;case "td":if(b.is(".day")&&!b.is(".disabled")){var f=parseInt(b.text(),10)||1;a=this.viewDate.getMonth();b.is(".old")?a-=1:b.is(".new")&&(a+=1);b=this.viewDate.getFullYear();
this.date=new Date(b,a,f,0,0,0,0);this.viewDate=new Date(b,a,Math.min(28,f),0,0,0,0);this.fill();this.set();this.element.trigger({type:"changeDate",date:this.date,viewMode:c.modes[this.viewMode].clsName})}}},mousedown:function(a){a.stopPropagation();a.preventDefault()},showMode:function(a){a&&(this.viewMode=Math.max(this.minViewMode,Math.min(2,this.viewMode+a)));this.picker.find(">div").hide().filter(".datepicker-"+c.modes[this.viewMode].clsName).show()}};d.fn.datepicker=function(a,b){return this.each(function(){var f=
d(this),c=f.data("datepicker"),e="object"===typeof a&&a;c||f.data("datepicker",c=new k(this,d.extend({},d.fn.datepicker.defaults,e)));if("string"===typeof a)c[a](b)})};d.fn.datepicker.defaults={onRender:function(a){return""}};d.fn.datepicker.Constructor=k;var c={modes:[{clsName:"days",navFnc:"Month",navStep:1},{clsName:"months",navFnc:"FullYear",navStep:1},{clsName:"years",navFnc:"FullYear",navStep:10}],dates:{days:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" "),daysShort:"Sun Mon Tue Wed Thu Fri Sat Sun".split(" "),
daysMin:"Su Mo Tu We Th Fr Sa Su".split(" "),months:"January February March April May June July August September October November December".split(" "),monthsShort:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ")},isLeapYear:function(a){return 0===a%4&&0!==a%100||0===a%400},getDaysInMonth:function(a,b){return[31,c.isLeapYear(a)?29:28,31,30,31,30,31,31,30,31,30,31][b]},parseFormat:function(a){var b=a.match(/[.\/\-\s].*?/);a=a.split(/\W+/);if(!b||!a||0===a.length)throw Error("Invalid date format.");
return{separator:b,parts:a}},parseDate:function(a,b){var d=a.split(b.separator);a=new Date;var c;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);if(d.length===b.parts.length){for(var e=a.getFullYear(),k=a.getDate(),g=a.getMonth(),h=0,l=b.parts.length;h<l;h++)switch(c=parseInt(d[h],10)||1,b.parts[h]){case "dd":case "d":k=c;a.setDate(c);break;case "mm":case "m":g=c-1;a.setMonth(c-1);break;case "yy":e=2E3+c;a.setFullYear(2E3+c);break;case "yyyy":e=c,a.setFullYear(c)}a=new Date(e,g,
k,0,0,0)}return a},formatDate:function(a,b){var c={d:a.getDate(),m:a.getMonth()+1,yy:a.getFullYear().toString().substring(2),yyyy:a.getFullYear()};c.dd=(10>c.d?"0":"")+c.d;c.mm=(10>c.m?"0":"")+c.m;a=[];for(var d=0,e=b.parts.length;d<e;d++)a.push(c[b.parts[d]]);return a.join(b.separator)},headTemplate:'<thead><tr><th class="prev">&lsaquo;</th><th colspan="5" class="switch"></th><th class="next">&rsaquo;</th></tr></thead>',contTemplate:'<tbody><tr><td colspan="7"></td></tr></tbody>'};c.template='<div class="datepicker dropdown-menu"><div class="datepicker-days"><table class=" table-condensed">'+
c.headTemplate+'<tbody></tbody></table></div><div class="datepicker-months"><table class="table-condensed">'+c.headTemplate+c.contTemplate+'</table></div><div class="datepicker-years"><table class="table-condensed">'+c.headTemplate+c.contTemplate+"</table></div></div>"}(window.jQuery);