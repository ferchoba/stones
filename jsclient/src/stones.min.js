/*
 * Stones
 * Copyright (c) 2013 Carlos León
 *
 * Licensed under the MIT license (http://mit-license.org/)
 */

window.stones = {};

(function ($, angular, window) {
  // Stones module definition and configuration
  'use strict';
  window.stones = angular.module('stones', []);
  window.stones.config([
    '$locationProvider',
    function ($locationProvider) {
      $locationProvider.hashPrefix('!');
    }]);
  window.stones.run([
    '$rootScope',
    'stones.translator_opts',
    function ($rootScope, translator_opts) {
      $rootScope.$_ = translator_opts.translate;
    }]);
}(window.jQuery, window.angular, window));

(function ($, angular, stones) {
  // Stones services
  'use strict';
  stones.factory('stones.server_error_handler', [
    '$exceptionHandler',
    function ($exceptionHandler) {
      return function (data) {
        console.log(data.status);
      };
    }]);
  stones.factory('stones.GetEntities', [
    '$http',
    'stones.server_error_handler',
    function ($http, server_error_handler) {
      return function (url, params) {
        var http_opts = {
          url: url,
          params: params,
          method: 'GET'
        };

        return $http(http_opts).then(function (data) {
          return data.data;
        }, function (data) {
          server_error_handler(data);
          return null;
        });
      };
    }]);

}(window.jQuery, window.angular, window.stones));

(function ($, angular, stones) {
  // Stones directives
  'use strict';
  stones.directive('stNumber', [
    function () {
      return {
        require: '^?ngModel',
        link: function (scope, elm, attrs, ctrl) {
          if (!ctrl) { return; }
          function validator (value) {
            if (!angular.isNumber(value)) {
              var transformed = Number(value);
              if (transformed === 0 || Boolean(transformed)) {
                return transformed;
              } else {
                ctrl.$setValidity('stNumberError', false);
                ctrl.$setViewValue(null);
              }
            }
            return value;
          }

          ctrl.$parsers.push(validator);
          ctrl.$formatters.push(validator);
        }
      };
    }]);
  stones.directive('stTypeahead', [
    '$parse',
    '$compile',
    function ($parse, $compile) {
      var tpl = '<ul class="typeahead dropdown-menu st-typeahead"><li ng-repeat="$item in $matched_items" ng-click="$select_item($item)" ng-class="$set_item_class($item)"><a href="">{{$item.label}}</a></li></ul>',
        typeahead_controller;
      typeahead_controller = [
        '$scope',
        '$attrs',
        function ($scope, $attrs) {
          var label_attr = $attrs.stLabel,
            value_attr = $attrs.stValue,
            deny_new = Boolean($attrs.stDenyNew),
            select_fn = $parse($attrs.stSelect),
            sort_fn = $parse($attrs.stSort),
            ctrl = this;

          ctrl.model_ctrl = null;
          ctrl.elm = null;
          ctrl.menu = null;
          ctrl.current_item = null;
          ctrl.focused = false;
          ctrl.mousedover = false;
          ctrl.index = null;
          ctrl.source = [];
          ctrl.show_counter = 0;

          $scope.$matched_items = [];
          $scope.$watch('current_item', function (value, old) {
            if (value && value !== old) {
              ctrl.model_ctrl.$setViewValue(value.label);
            }
          });

          ctrl.set_index = function (index) {
            ctrl.index = index;
          };

          ctrl.set_menu = function (menu) {
            ctrl.menu = angular.element(menu);
            ctrl.menu.bind('mouseenter', ctrl.mouseenter);
            ctrl.menu.bind('mouseleave', ctrl.mouseleave);
          };

          ctrl.set_element = function (elm) {
            ctrl.elm = angular.element(elm);
          };

          ctrl.set_model_ctrl = function (model_ctrl) {
            ctrl.model_ctrl = model_ctrl;
          }

          ctrl.set_source = function (value) {
            var items = [];
            function get_label(item) {
              if (label_attr) {
                return item[label_attr];
              } else {
                return item;
              }
            }

            function get_value(item) {
              if (value_attr) {
                return item[value_attr];
              } else {
                return item;
              }
            }

            if (angular.isArray(value)) {
              value.each(function (n) {
                items.push({
                  label: get_label(n),
                  value: get_value(n)
                });
              });
            } else if (angular.isObject(value)) {
              for (var key in value) {
                items.push({
                  label: key,
                  value: get_value(value[key])
                });
              }
            }
            ctrl.source = items;
          };

          ctrl.match_items = function (value, digest) {
            if (ctrl.show_counter === 0) { return; }
            var sort = sort_fn($scope);
            if (!value || value === '') {
              $scope.$matched_items = ctrl.source;
            } else {
              $scope.$matched_items = ctrl.source.filter(function (n) {
                return n.label.toLowerCase().has(value.toLowerCase());
              });
              $scope.$matched_items = $scope.$matched_items || [];
              if ($scope.$matched_items.length > 0) {
                $scope.$matched_items.each(function (n) {
                  if (n.label === value) ctrl.selected = true;
                });
              }
            }
            if (sort) {
              $scope.$matched_items = $scope.$matched_items.sortBy(sort);
            } else if (sort === false) {
              // no sort
            } else {
              $scope.$matched_items = $scope.$matched_items.sortBy('label');
            }
            ctrl.current_item = $scope.$matched_items[0];
            if (digest) {
              try { $scope.$apply(); } catch (e) {}
            }
            ctrl.show();
          };

          ctrl.select_item = function (item) {
            var fn = select_fn($scope);
            function select(local_item) {
              ctrl.model_ctrl.$setViewValue(local_item.label);
              ctrl.elm.val(local_item.label);
              if (fn && angular.isFunction(fn)) {
                fn(local_item.value, ctrl.index);
              }
            }
            if (item) {
              select(item);
            } else {
              item = ctrl.current_item;
              if (item) {
                select(item);
              } else {
                if (deny_new) {
                  ctrl.model_ctrl.$setViewValue('');
                  ctrl.elm.val('');
                  if (fn && angular.isFunction(fn)) {
                    fn();
                  }
                }
              }
            }
            ctrl.hide();
            ctrl.show_counter = 0;
          };

          ctrl.keydown = function (e) {
            switch (e.keyCode) {
              case 9:
                ctrl.select_item();
                break;
              case 13:
                e.preventDefault();
                ctrl.select_item();
                break;
              case 38:
                ctrl.next();
                break;
              case 40:
                ctrl.prev();
                break;
              case 27:
                ctrl.hide();
                break;
              default:
                ctrl.show_counter++;
            }
          };

          ctrl.prev = function () {
            var index = $scope.$matched_items.indexOf(ctrl.current_item);
            if (index === $scope.$matched_items.length - 1) {
              index -= 1;
            }
            ctrl.current_item = $scope.$matched_items[index + 1];
            try { $scope.$apply(); } catch (e) {}
          };

          ctrl.next = function () {
            var index = $scope.$matched_items.indexOf(ctrl.current_item);
            if (index === 0) {
              index += 1;
            }
            ctrl.current_item = $scope.$matched_items[index - 1];
            try { $scope.$apply(); } catch (e) {}
          };

          ctrl.focus = function (e) {
            var empty = e.currentTarget.value === '';
            if (empty) { ctrl.show_counter++; }
            ctrl.focused = true;
            ctrl.match_items(e.currentTarget.value, true);
          };

          ctrl.blur = function (e) {
            ctrl.focused = false;
            if (!ctrl.mousedover) { ctrl.hide(); }
          };

          ctrl.show = function () {
            if ($scope.$matched_items.length > 0) {
              var offset = ctrl.elm.offset();
              offset.top += ctrl.elm[0].offsetHeight + 2;
              ctrl.menu.css('top', offset.top);
              ctrl.menu.css('left', offset.left);
              ctrl.menu.show();
            } else {
              ctrl.hide();
            }
          };

          ctrl.hide = function () {
            ctrl.menu.hide();
          };

          ctrl.mouseenter = function (e) {
            ctrl.mousedover = true;
            ctrl.menu.find('li').removeClass('active');
          };

          ctrl.mouseleave = function (e) {
            ctrl.mousedover = false;
            var index = $scope.$matched_items.indexOf(ctrl.current_item);
            if (index !== -1) {
              ctrl.menu.find('li').eq(index).addClass('active');
            }
          };
        }];

      function linker(scope, elm, attrs, ctrl) {
        var typeahead_ctrl = ctrl[0],
          model_ctrl = ctrl[1],
          menu = null;
        if (!typeahead_ctrl || !model_ctrl) { return; }
        typeahead_ctrl.set_model_ctrl(model_ctrl);
        typeahead_ctrl.set_element(elm);
        if (scope.$index !== undefined) {
          typeahead_ctrl.set_index(scope.$index);
        }
        scope.$watch(attrs.stTypeahead, function (value) {
          typeahead_ctrl.set_source(value);
        });
        scope.$watch(attrs.ngModel, function (value, old) {
          if (value === old) { return; }
          typeahead_ctrl.match_items(value, false);
        });
        menu = $compile(tpl)(scope);
        typeahead_ctrl.set_menu(menu);
        angular.element('body').append(menu);
        scope.$on('$destroy', function (e) {
          menu.remove();
        });
        elm.bind('keydown', typeahead_ctrl.keydown);
        elm.bind('focus', typeahead_ctrl.focus);
        elm.bind('blur', typeahead_ctrl.blur);
        scope.$select_item = typeahead_ctrl.select_item;
        scope.$set_item_class = function (item) {
          var rv = '';
          if (item === typeahead_ctrl.current_item) {
            rv += 'active ';
          }
          return rv.trim();
        };
      }

      return {
        restrict: 'A',
        require: ['stTypeahead', '^?ngModel'],
        scope: true,
        controller: typeahead_controller,
        link: linker,
      };
    }]);
  stones.directive('stMenu', [
    '$location',
    function ($location) {
      return {
        restrict: 'EA',
        link: function (scope, elm) {
          var patterns = [];
          elm.find('a').map(function (_, a) {
            patterns.push(a.hash.remove(/[#!\/]/g));
          });
          scope.$on('$routeChangeSuccess', function () {
            var current_path = Array.create($location.path().split('/')
                .remove('')),
              match = current_path.join('');
            elm.find('a').map(function (_, a) {
              var ul, li;
              if (match === a.hash.remove(/[#!\/]/g)) {
                li = angular.element(a).parent();
                ul = li.parent();
                ul.find('li').removeClass('active');
                li.addClass('active');
              }
            });
          });
        }
      };
    }]);
  stones.directive('input', [
    // range support to input
    function () {
      return {
        restrict: 'E',
        require: '?ngModel',
        link: function (scope, elm, attrs, ctrl) {
          if (!ctrl || attrs.type !== 'range') { return; }
          function listener() {
            var value = elm.val().toNumber();
            if (ctrl.$viewValue !== value) {
              scope.$apply(function () {
                ctrl.$setViewValue(value);
              });
            }
          }
          elm.bind('change', listener);
        }
      }
    }]);
  stones.directive('input', [
    // type file support to input
    function () {
      return {
        restrict: 'E',
        require: '?ngModel',
        link: function (scope, elm, attrs, ctrl) {
          if (!ctrl || attrs.type !== 'file') { return; }
          var mimetype = attrs.mimetype,
            listener = function () {
              var file = elm[0].files[0],
                reader = new FileReader();
              reader.onload = function (f) {
                var result = f.target.result;
                scope.$apply(function () {
                  ctrl.$setViewValue(result);
                });
              };
              if (mimetype === undefined || file.type.has(mimetype)) {
                reader.readAsDataURL(file);
              } else {
                scope.$apply(function () {
                  ctrl.$setViewValue('');
                });
                elm.val('');
              }
            };
          elm.bind('change', listener);
          ctrl.$render = function () {};
        }
      };
    }]);
  stones.directive('stFilter', [
    '$compile',
    '$parse',
    function ($compile, $parse) {
      return {
        link: function (scope, elm, attrs) {
          var control_tpl = scope.$filter.control_tpl,
            control;
          if (control_tpl === 'textinput' || control_tpl === undefined) {
            control_tpl = '<input style="margin-bottom:0;" type="text" ng-class="$filter.css_class" ng-model="$search_obj.{1}">'.assign(scope.$filter.search_obj_attr);
          }
          if (control_tpl) {
            control = $compile(control_tpl)(scope);
            elm.replaceWith(control);
          }
        }
      }
    }]);
  stones.directive('stEntitiesTable', [
    '$compile',
    '$parse',
    '$location',
    '$http',
    '$routeParams',
    '$timeout',
    '$filter',
    'stones.server_error_handler',
    function ($compile, $parse, $location, $http, $routeParams, $timeout,
        $filter, server_error_handler) {
      var tpl = '<div class="entities-container-filters" ng-class="$filters_container_classes" ng-show="$filtered"><h1>{{$_("Filters")}}</h1><div class="entities-container-filter" style="margin-bottom:10px;" ng-class="$filter_container_classes" ng-repeat="$filter in $filters"><label><i class="icon-minus-sign pull-right" ng-show="$filter.remove" ng-click="$remove_filter($filter)"></i>{{$filter.label}}</label><div st-filter></div></div></div><div class="entities-container-title" ng-class="$title_container_classes"><h1>{{$title}} <i ng-show="$actions.add" style="cursor:pointer;" title="{{$_(\'Add entity\')}}" class="icon-plus-sign pull-right" ng-click="$update_route_params(\'new\')"></i> <span class="pull-right clearfix title_addon_container" ng-bind-html-unsafe="$title_addon($entities)"></span></h1></div><div class="entities-table-container" ng-class="$table_container_classes"><table class="table table-bordered table-striped table-hover" ng-class="$table_classes"><thead><th></th><th ng-repeat="h in $table_headers">{{$_(h.label)}}</th><th></th></thead><tbody><tr ng-repeat="$entity in $entities_filtered"><td style="text-align:center;" ng-bind-html-unsafe="$entity_info($entity)"></td><td ng-repeat="h in $table_headers" ng-bind-html-unsafe="$get_value($entity, h.attr)"></td><td style="text-align:center;"><span ng-bind-html-unsafe="$entity_addon($entity)"></span> <i ng-show="$actions.edit" style="cursor:pointer;" title="{{$_(\'Edit entity\')}}" class="icon-pencil" ng-click="$update_route_params($entity.$$key$$)"></i> <i ng-show="$actions.erase" style="cursor:pointer;" title="{{$_(\'Erase entity\')}}" class="icon-trash" ng-click="$show_erase_confirmation($entity)"></i></td></tr><tr ng-show="!$entities_loaded"><td colspan="{{$table_headers.length + 2}}"><i class="icon-spin icon-spinner"></i> {{$_("Loading...")}}</td></tr><tr ng-show="$entities_loaded && $entities_filtered.length == 0"><td colspan="{{$table_headers.length + 2}}">{{$_("Nothing to show.")}}</td></tr></tbody></table></div>',
        modal_tpl = '<div class="modal hide fade" id="delete-modal"><div class="modal-header"><h3>{{$_("Erase one entity")}}</h3></div><div class="modal-body"><p>{{$_("You are going to erase this entity. Are you sure?")}}</p></div><div class="modal-footer"><button class="btn btn-danger" ng-click="$erase()">{{$_("Yes, i\'m sure.")}}</button><button class="btn btn-success" ng-click="$hide_erase_confirmation()">{{$_("No. Get me out of here.")}}</button></div></div>',
        st_entities_table_ctrl;
      st_entities_table_ctrl = ['$scope', '$element', '$attrs',
        function (scope, elm, attrs) {
          scope.$entities = [];
          scope.$entities_filtered = [];
          scope.$filters = scope.filters;
          scope.$search_obj = {};
          scope.$filtered = scope.filters && (scope.filters.length > 0);
          scope.$watch(function () {
            scope.$entities_filtered = $filter('stFilter')(scope.$entities,
              scope.$filters, scope.$search_obj);
          });
          scope.$remove_filter = function (filter) {
            delete scope.$search_obj[filter.search_obj_attr];
          };
          scope.$entity_addon = scope.entity_addon;
          scope.$entity_info = scope.entity_info;
          scope.$title_addon = scope.title_addon;
          scope.$table_container_classes = attrs.tableContainerClasses;
          scope.$table_classes = attrs.tableClasses;
          scope.$title_container_classes = attrs.titleContainerClasses;
          scope.$filters_container_classes = attrs.filtersContainerClasses;
          scope.$filter_container_classes = attrs.filterContainerClasses;
          scope.$table_headers = scope.table_headers || [];
          scope.$remote_url = scope.remote_url;
          if (scope.$remote_url === undefined) {
            throw 'EntitiesTableError: No remote url defined.';
          }
          scope.$local_url = scope.local_url || '';
          scope.$title = attrs.title && attrs.title.capitalize();
          scope.$actions = {
            add: attrs.actions && attrs.actions.toLowerCase().has('c'),
            edit: attrs.actions && attrs.actions.toLowerCase().has('u'),
            erase: attrs.actions && attrs.actions.toLowerCase().has('d')
          };
          scope.$entities_loaded = false;
          scope.$update_route_params = function (sufix) {
            var current = $location.path();
            $location.path(current + sufix + '/');
          };
          scope.$get_value = function ($entity, attr) {
            var rv,
              label_tpl = '<span class="label label-info">{1}</span>';
            if (angular.isFunction(attr)) {
              rv = attr($entity);
            } else {
              rv = $parse(attr)($entity);
            }
            if (Object.isArray(rv)) {
              rv = rv.map(function (n) {
                return label_tpl.assign(n);
              }).join(' ');
            }
            return rv;
          };
          scope.$show_erase_confirmation = function (entity) {
            scope.$active_entity = entity;
            $('#delete-modal').modal('show');
          };
          scope.$hide_erase_confirmation = function () {
            scope.$active_entity = null;
            $('#delete-modal').modal('hide');
          };
          scope.$erase = function () {
            $http({
              url: scope.$remote_url + scope.$active_entity.$$key$$,
              method: 'DELETE'
            }).then(function (data) {
              scope.$entities.remove(scope.$active_entity);
              scope.$active_entity = null;
              $('#delete-modal').modal('hide');
            }, function (data) {
              server_error_handler(data);
            })
          };
          // get entities
          scope.$aditional_params = scope.aditional_params;
          scope.$cache = scope.cache;
          scope.$load_entities = function () {
            var http_opts = {
              url: scope.$remote_url,
              method: 'GET',
              params: $routeParams
            };
            if (scope.$cache) {
              var cache_name = http_opts.url;
              if (Object.size($routeParams) > 0) {
                cache_name += '?' + $.param($routeParams);
              }
              scope.$cache.put(cache_name, '');
              scope.$cache.remove(cache_name);
              http_opts.cache = scope.$cache;
            }
            if (scope.$aditional_params) {
              angular.extend(http_opts.params, scope.$aditional_params);
            }
            $http(http_opts).then(function (data) {
              scope.$entities = data.data;
              scope.$entities_loaded = true;
            }, function (data) {
              server_error_handler(data);
              scope.$entities_loaded = true;
            });
          };
        }];

      return {
        restrict: 'EA',
        scope: true,
        controller: st_entities_table_ctrl,
        link: function (scope, elm, attrs, ctrl) {
          elm.removeAttr('title');
          elm.replaceWith($compile(tpl)(scope));

          var modal = $compile(modal_tpl)(scope);
          angular.element('body').append(modal);
          scope.$on('$destroy', function () {
            modal.remove();
          });
          $('#delete-modal').modal({show: false});

          $timeout(scope.$load_entities, 2000);
        }
      };
    }]);
  stones.directive('required', [
    'stones.translator',
    '$compile',
    function (_, $compile) {
      return {
        require: '?ngModel',
        restrict: 'A',
        link: function (scope, elm, attrs, ctrl) {
          if (!ctrl) { return; }
          var error_tpl = '<div class="error">{1}</div>',
            error_elm = $compile(
              error_tpl.assign(_('This field is mandatory.'))
            )(scope);
          $(elm).after(error_elm);
          scope.$watch(attrs.ngModel, function (value) {
            if (!value && ctrl.$dirty) {
              error_elm.css('display', 'block');
            } else {
              error_elm.css('display', 'none');
            }
          });
        }
      };
    }]);

  stones.directive('placeholder', [
    function () {
      return {
        require: '?ngModel',
        restrict: 'A',
        link: function (scope, elm, attrs, ctrl) {
          if (!ctrl) { return; }
          var placeholder = attrs.placeholder,
            placeholder_tpl = '<span class="control-placeholder">{1}</span>',
            placeholder_elm = $(placeholder_tpl.assign(placeholder)),
            control_parent = $('<div class="control inline"></div>');
          elm.wrap(control_parent);
          placeholder_elm.css('position', 'absolute');
          $(elm).before(placeholder_elm).removeAttr('placeholder');
          placeholder_elm.bind('click', function (e) {
            $(elm).focus();
          });
          scope.$watch(attrs.ngModel, function (value) {
            if (value === undefined || value === null || value === '') {
              placeholder_elm.css('display', 'inline-block');
            } else {
              placeholder_elm.css('display', 'none');
            }
          });
        }
      };
    }]);

  stones.directive('stPlaceholder', [
    '$compile',
    function ($compile) {
      return {
        require: '?ngModel',
        restrict: 'A',
        priority: 99,
        link: function (scope, elm, attrs, ctrl) {
          if (!ctrl) { return; }
          scope.$placeholder = '';
          var placeholder_tpl = '<span class="control-placeholder">{{$placeholder}}</span>',
            placeholder_elm = $compile(placeholder_tpl)(scope);
          $(elm).before(placeholder_elm).removeAttr('placeholder');
          placeholder_elm.css('position', 'absolute');
          placeholder_elm.bind('click', function (e) {
            $(elm).focus();
          });
          attrs.$observe('stPlaceholder', function (value) {
            scope.$placeholder = value;
          });
          scope.$watch(attrs.ngModel, function (value) {
            if (value === undefined || value === null || value === '') {
              placeholder_elm.css('display', 'inline-block');
            } else {
              placeholder_elm.css('display', 'none');
            }
          });
        }
      };
    }]);
}(window.jQuery, window.angular, window.stones));

(function ($, angular, stones) {
  // locales definition
  'use strict';
  stones.constant('stones.locales', {
    es: {
      'This field is mandatory.': 'Este campo es obligatorio.',
      'Nothing to show.': 'Nada que mostrar.',
      'Loading...': 'Cargando...',
      'Add entity': 'Agregar entidad',
      'Edit entity': 'Editar entidad',
      'Erase one entity': 'Borrar una entidad',
      'You are going to erase this entity. Are you sure?': 'Estás a punto de borra esta entidad. ¿Estás seguro/a?',
      'Yes, i\'m sure.': 'Sí, lo estoy.',
      'No. Get me out of here.': 'No. Sácame de aquí.',
      'Filters': 'Filtros'
    }
  });
}(window.jQuery, window.angular, window.stones));

(function ($, angular, stones) {
  // locale support
  'use strict';
  stones.factory('stones.translator_opts', [
    '$window',
    'stones.locales',
    function ($window, default_locales) {
      var lang = $window.navigator.language ||
          $window.navigator.userLanguage || $window.navigator.systemLanguage,
        locales = default_locales;
      lang = lang.to(2);
      $('body').append(
        '<script src="/static/j/locales/{1}.js"><\/script>'.assign(lang)
      );
      if ($window.Date.getLocale(lang)) {
        $window.Date.setLocale(lang);
      }
      return {
        set_locale: function (lang_) {
          lang = lang_;
        },
        get_locale: function () {
          return lang;
        },
        add_locale_table: function (lang_, hash) {
          locales[lang_] = hash;
        },
        translate: function (str) {
          var locale = locales[lang],
            rv;
          if (locale === undefined) { return str; }
          rv = locale[str];
          if (rv === undefined) { return str; }
          return rv;
        }
      };
    }]);
  stones.factory('stones.translator', [
    'stones.translator_opts',
    function (translator) {
      return translator.translate;
    }]);
}(window.jQuery, window.angular, window.stones));

(function ($, angular, stones) {
  // Filters
  'use strict';
  stones.filter('stFilter', [
    '$parse',
    function ($parse) {
      return function (input, filters, search_obj) {
        filters = filters || [];
        if (!angular.isArray(filters)) {
          throw 'StonesFilterError: filters should be an array.';
        }
        filters.each(function (filter) {
          var value = search_obj[filter.search_obj_attr],
            entity_value;
          if (value !== undefined) {
            input = input.filter(function (entity) {
              if (angular.isFunction(filter.filter)) {
                return filter.filter(entity, value);
              } else if (angular.isString(filter.filter)) {
                entity_value = $parse(filter.filter)(entity) || '';
                if (entity_value.toLowerCase === undefined) {
                  throw 'StonesFilterError: You cannot perform default filter behavior over entity attributes but strings. Found {1}. You need to define a custom behavior in the filter definition.'.assign(typeof entity_value);
                }
                if (value.toLowerCase === undefined) {
                  throw 'StonesFilterError: You cannot perform default filter behavior over search arguments but strings. Found {1}. You need to define a custom behavior in the filter definition.'.assign(typeof entity_value);
                }
                return entity_value.toLowerCase().has(value.toLowerCase());
              }
            });
          }
        });
        return input;
      }
    }]);
}(window.jQuery, window.angular, window.stones));
